
<html>
<head>
<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css"
      integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
       integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

<script src="lib.js"></script>

</head>
<body>
<div class="container-fluid">
<h1>Ingest Stream State</h1>

<form>Filters:
<label>Stream name</label><input type="text" name="namefilter" id="name_filter"/>
<label>Owner</label><input type="text" name="owner" id="owner_filter"/>
<label>Don't show OK</label><input type="checkbox" name="hide_ok" id="hide_ok"/>
<input type="submit" value="filter">


<div class="alert alert-light" role="alert" id="key">
    Key:
    <a href="#" class="btn btn-outline-primary active">Running</a>
    <a href="#" class="btn btn-outline-success active">Recently finished</a>
    <a href="#" class="btn btn-outline-success">Ran OK</a>
    <a href="#" class="btn btn-outline-warning">Errors</a>
    <a href="#" class="btn btn-outline-danger">Failed</a>
    <a href="#" class="btn btn-outline-dark">Killed <i class="fas fa-skull"></i></a>
    <a href="#" class="btn btn-outline-success">Over an hour <i class="fas fa-stopwatch"></i></a>
    <a href="#" class="btn btn-outline-success">Manual <i class="fas fa-hand-pointer"></i></a>
</div>

</div>
</form>

<div id="streams"></div>

</div>

<script>

function get_last_logs()
{
    var outut = {};
    $.post({
                url: "http://jasmin-es1.ceda.ac.uk:9200/ingest-log/_search",
                data: JSON.stringify(last_logs_query),
                success: function (data) {
                    for (i = 0; i < data.aggregations.stream.buckets.length; i++) {
                        var stream = data.aggregations.stream.buckets[i].key;
                        var last_log = data.aggregations.stream.buckets[i].recent_logs.hits.hits[0]._source;
                        var nlogs = data.aggregations.stream.buckets[i].recent_logs.hits.hits.length;
                        var counts = {};
                        for (var j=0; j < nlogs; j++) {
                            var doc = data.aggregations.stream.buckets[i].recent_logs.hits.hits[j]._source;
                            if (doc.state in counts) {
                                counts[doc.state]++;
                            } else {
                                counts[doc.state] = 1;
                            }
                        }
                        last_log.counts = counts;
                        last_log.nlogs = nlogs;

                        outut[stream] = last_log;
                    }
                    outpt = outut; // set global var
                    refresh_page_info(outut);
                    setTimeout(get_last_logs, 5000);
                },

                error: function (data) {
                    console.log(data)
                },
                contentType: "application/json"
            }
    );
    return outut;
}


//
function refresh_page_info(a) {
    // function to refresh the stream info on the page
    streams_div.empty();

    for (var s in a) {
        // skip streams that do not match the name filter
        if (name_filter && !(s.includes(name_filter))) {continue}

        // skip streams that do not match the owner
        var last_log = a[s];
        if (owner_filter) {
            if ("config" in last_log && "owner" in last_log.config) {
                if (!(last_log.config.owner.includes(owner_filter))) {
                    continue
                }   // skip if not the owner
            } else {
                continue; // skip if no owner defined
            }
        }

        // skip ok streams if flag set
        if (hide_ok && last_log.state == "ok") {continue}

        // make button and add to the display
        w = stream_button(last_log);
        streams_div.append(w);
    }
    streams_div.html("<div>"+ streams_div.html()+"</div>");
}


streams_div = $("#streams");
z = $("#z");

var outpt = get_last_logs();

// populate form from url
var urlParams = new URLSearchParams(window.location.search);
var name_filter = urlParams.get("namefilter");
$('#name_filter').attr("value", name_filter);
var owner_filter = urlParams.get("owner");
$('#owner_filter').attr("value", owner_filter);
var hide_ok = urlParams.get("hide_ok");
$('#hide_ok').prop("checked", hide_ok);



</script>
</body>
</html>
