
<html>
<head>
<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css"
      integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
       integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

<script src="lib.js"></script>

</head>
<body>
<div class="container-fluid">
<h1>Ingest Stream State</h1>

    <form>Filters:
        <label>Stream name </label><input type="text" name="namefilter" id="name_filter"/>
        <label>Owner </label><input type="text" name="owner" id="owner_filter"/>

        <input type="submit" value="filter">


        <input type="radio" name="reclen" id="reclen_30" value="30" checked>Last months records
        <input type="radio" name="reclen" id="reclen_36500" value="36500">All records


        <label>Ingest1 </label><input type="checkbox" name="ingest1" id="ingest1">
        <label>Ingest2 </label><input type="checkbox" name="ingest2" id="ingest2">
        <label>Ingest3 </label><input type="checkbox" name="ingest3" id="ingest3">




<div class="alert alert-light" role="alert" id="states">
    State filters:
    <button class="btn btn-outline-primary active" id="running" onclick="button_filter(this);">
        <input type="checkbox" name="running"> Running</button>
    <button class="btn btn-outline-success" id="ok" onclick="button_filter(this);">
        <input type="checkbox" name="ok"> Ran OK</button>
    <button class="btn btn-outline-warning" id="warn" onclick="button_filter(this);">
        <input type="checkbox" name="warn"> Errors <i class="fas fa-exclamation-triangle"></i></button>
    <button class="btn btn-outline-danger" id="fail" onclick="button_filter(this);">
        <input type="checkbox" name="fail"> Failed <i class="fas fa-bell"></i></button>
    <button class="btn btn-outline-dark" id="killed" onclick="button_filter(this);">
        <input type="checkbox" name="killed"> Killed <i class="fas fa-skull"></i></button>
    <button class="btn btn-outline-dark" id="died" onclick="button_filter(this);">
        <input type="checkbox" name="died"> Died <i class="fas fa-bomb"></i></button>
     <button class="btn btn-outline-secondary" id="do_not_run" onclick="button_filter(this);">
        <input type="checkbox" name="do_not_run" > do_not_run <i class="fas fa-ban"></i></button>
     <button class="btn btn-outline-success" id="ok-errors" onclick="button_filter(this);">
        <input type="checkbox" name="ok-errors" > ok-errors <i class="fas fa-exclamation-triangle"></i></button>
     <button class="btn btn-outline-info" id="new" onclick="button_filter(this);">
        <input type="checkbox" name="new" > new <i class="fas fa-asterisk"></i></button>
     <button class="btn btn-outline-info" id="cleanup" onclick="button_filter(this);">
        <input type="checkbox" name="cleanup" > cleanup <i class="fas fa-broom"></i></button>
     <button class="btn btn-outline-info" id="re-running" onclick="button_filter(this);">
        <input type="checkbox" name="re-running" > re-running <i class="fas fa-cog"></i></button>
</div>
    <div class="alert alert-light" role="alert" id="key">
    Key:
    <span class="btn btn-success" id="recent">Recently finished</span>
    Over an hour <i class="fas fa-stopwatch"></i>
    Cron <i class="fas fa-redo"></i>
</div>


</form>

<div id="streams">
<image src="Loading_icon.gif"></image>
</div>

    </div>
</body>
<script>

function get_last_logs()
{
    var outut = {};
    $.post({
                url: "http://jasmin-es1.ceda.ac.uk:9200/ingest-log/_search",
                data: JSON.stringify(last_logs_query),
                success: function (data) {
                    for (i = 0; i < data.aggregations.stream.buckets.length; i++) {
                        var stream = data.aggregations.stream.buckets[i].key;
                        var last_log = data.aggregations.stream.buckets[i].recent_logs.hits.hits[0]._source;
                        var nlogs = data.aggregations.stream.buckets[i].recent_logs.hits.hits.length;
                        var counts = {};
                        for (var j=0; j < nlogs; j++) {
                            var doc = data.aggregations.stream.buckets[i].recent_logs.hits.hits[j]._source;
                            if (doc.state in counts) {
                                counts[doc.state]++;
                            } else {
                                counts[doc.state] = 1;
                            }
                        }
                        last_log.counts = counts;
                        last_log.nlogs = nlogs;

                        outut[stream] = last_log;
                    }
                    outpt = outut; // set global var
                    refresh_page_info(outut);
                    setTimeout(get_last_logs, 5000);
                },

                error: function (data) {
                    console.log(data)
                },
                contentType: "application/json"
            }
    );
    return outut;
}


//
function refresh_page_info(a) {
    // function to refresh the stream info on the page
    streams_div.empty();

    for (var s in a) {

        // skip streams by name filter
        if (name_filter) {
            // if the name filter starts with "!" then skip matching streams
            if (name_filter.startsWith("!")) {
                if (s.includes(name_filter.substring(1))) {continue}
            }
            // otherwise skip ones that do not match
            else {
                if (!(s.includes(name_filter))) {continue}
            }
        }

        // skip streams that do not match the owner
        var last_log = a[s];
        if (owner_filter) {
            if ("config" in last_log && "owner" in last_log.config) {
                if (!(last_log.config.owner.includes(owner_filter))) {
                    continue
                }   // skip if not the owner
            } else {
                continue; // skip if no owner defined
            }
        }

        // skip if state filter
        if (!(states_filter.includes(last_log.state))) {continue}
        // skip if host filter
        if ( !(ingest1) && last_log.host == 'ingest1.ceda.ac.uk') {continue}
        if ( !(ingest2) && last_log.host == 'ingest2.ceda.ac.uk') {continue}
        if ( !(ingest3) && last_log.host == 'ingest3.ceda.ac.uk') {continue}


        // make button and add to the display
        w = stream_button(last_log);
        streams_div.append(w);
    }
    streams_div.html("<div>"+ streams_div.html()+"</div>");
}


streams_div = $("#streams");
z = $("#z");

var outpt = get_last_logs();

// populate form from url
var urlParams = new URLSearchParams(window.location.search);
$('#name_filter').attr("value", name_filter);
$('#owner_filter').attr("value", owner_filter);

$('#reclen_'+reclen).prop("checked", true);

for (var i=0; i< states_filter.length; i++) {
    $('#'+states_filter[i]+' :input').prop("checked", states_filter[i]);
}

if (ingest1) {$('#ingest1').prop('checked', ingest1)}
if (ingest2) {$('#ingest2').prop('checked', ingest2)}
if (ingest3) {$('#ingest3').prop('checked', ingest3)}




</script>

</html>
