
<html>
<head>
<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css"
      integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
       integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

<script src="lib.js"></script>
<script src="diagram_comp.js"></script>
<script src="colour_blender.js"></script>

   <script>
        function network_plot(host, size, period, report) {
            var image;
            image = '<image width="' + size + '" ';
            image += 'src="http://mgmt.jc.rl.ac.uk/ganglia/graph.php?h=' + host;
            image += '.ceda.ac.uk&m=load_one&r=' + period;
            image += '&s=by%20name&hc=4&mc=2&st=1561013641&g=' + report;
            image += '&z=medium&c=JASMIN%20Cluster"></image>';
            return image;
        }
</script>

</head>
<body>
<div class="container-fluid">
<h1>Archive State</h1>



    </div>



<div hidden>
    <img id="ganglia.png" src="ganglia.png"/>
    <img id="helpscout.png" src="helpscout.png"/>
    <img id="ingest_mon.png" src="ingest_mon.png"/>
    <img id="deposit_mon.png" src="deposit_mon.png"/>
    <img id="cat.png" src="cat.png"/>
    <img id="archive.png" src="archive.png"/>
    <img id="data.png" src="data.png"/>
    <img id="dap.png" src="dap.png"/>
    <img id="arrivals.png" src="arrivals.png"/>
</div>

<div>
<canvas id='canvas' height='900px' width='1200px'></canvas>
</div>

<script>
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    var mcolour = "rgba(100,100,100,0.3)";
    var c1 = "rgba(255,255,200,0.5)"; var c2 = "rgba(0,255,255,0.5)"; var c3 = "rgba(100,100,0,0.5)";
    var c4 = "rgba(255,100,0,0.5)"; var c5 = "rgba(0,255,200,0.5)"; var c6 = "rgba(100,100,100,0.5)";
    var c7 = "rgba(255,0,0,0.5)"; var c8 = "rgba(0,255,100,0.5)"; var c9 = "rgba(100,100,200,0.5)";
    var c10 = "rgba(255,0,200,0.5)"; var c11 = "rgba(0,255,0,0.5)"; var c12 = "rgba(100,200,200,0.5)";
    var dw = 20;
    var iw = 2;

    user(ctx, c8, 250, 10, "data provider", "https://secure.helpscout.net/mailbox/7b0c55db545d4969/1952553/");
    image_link(ctx, "helpscout.png", 260, 15, 20, 20, "https://secure.helpscout.net/mailbox/7b0c55db545d4969/1952553/");
    web_machine(ctx, 220, 50, 150,100,  mcolour, "arrivals", "arrivals", "arrivals.png", "arrivals", "https://arrivals.ceda.ac.uk");
    disk(ctx, c5, 400, 130, 70, 70, "/arrivals");
    //down_cink_arrow(ctx, c7, 430 , 150, 30, 100, 20, -60);
    down_cink_arrow2(ctx, c10, 300, 20, 430, 150, 50, 50, dw);

    disk(ctx, c8, 500, 130, 70, 70, "/processing3");
    //down_arrow(ctx, c10, 550, 150, 70);
    down_cink_arrow2(ctx, c12, 550, 20, 550, 150, 10, 30, dw);

    disk(ctx, c11, 600, 130, 70, 70, "/gws...");
    //down_arrow(ctx, c12, 650, 150, 70);
    down_cink_arrow2(ctx, c12, 650, 20, 650, 150, 10, 30, dw);

    machine_group(ctx, 560, 350, 150,100,  mcolour, "deposit", 5);
    image_link(ctx, "deposit_mon.png", 565, 350, 105, 75, "https://archdash1.ceda.ac.uk/current/a_sum");


    //down_cink_arrow(ctx, c4, 610 , 500, 20, 140, 230, -85);
    //down_cink_arrow(ctx, c5, 610 , 500, 30, 50 , 210, -75);
    //down_cink_arrow(ctx, c6, 610 , 500, 60, 30, 190, 75);
    down_cink_arrow2(ctx, c12, 430, 200, 610, 480, 30, 200, dw);
    down_cink_arrow2(ctx, c12, 550, 200, 610, 480, 30, 220, dw);
    down_cink_arrow2(ctx, c12, 650, 200, 610, 480, 60, 200, dw);


    //down_cink_arrow(ctx, c7, 710 , 750, 20, 80, 130, -85);
    //down_cink_arrow(ctx, c8, 610 , 750, 90, 50 , 20, -20);
    //down_cink_arrow(ctx, c9, 450 , 750, 10, 110, 150, 90);
    down_cink_arrow2(ctx, c12, 610, 580, 710, 750, 20, 140, dw);
    down_cink_arrow2(ctx, c12, 610, 580, 610, 750, 20, 140, dw);
    down_cink_arrow2(ctx, c12, 610, 580, 450, 750, 20, 140, dw);


    machine_group(ctx, 170, 350, 150,120,  mcolour,  "ingest", 5);
    image_link(ctx, "ingest_mon.png", 175, 350, 105, 75, "http://stats.ceda.ac.uk/ingest_state/index.html?namefilter=&owner=&reclen=30&ingest1=on&ingest2=on&ingest3=on&running=on&warn=on&fail=on&killed=on&died=on");
    arrow_cink(ctx, 'black', 250, 130, 250, 250, 200, 250, 200, 350, iw);


    machine(ctx, 350, 300, 150,200,  mcolour, "rbq");
    queue(ctx, c8, 370, 370, 100, 20,  "deposit_rpc");
    queue(ctx, c9, 370, 420, 100, 20,  "fast");
    queue(ctx, c9, 370, 460, 100, 20,  "slow");
    arrow_cink(ctx, 'black', 280, 380, 280, 380, 280, 380, 370, 380, iw);
    arrow(ctx, 'black', 470, 380, 550, 380, iw);

    arrow_cink(ctx, 'black', 470, 430, 520, 430, 520, 450, 750, 450, iw);
    arrow_cink(ctx, 'black', 470, 470, 520, 470, 520, 450, 750, 450, iw);
    arrow_cink(ctx, 'black', 550, 400, 330, 400, 330, 430, 370, 430, iw);
    arrow_cink(ctx, 'black', 550, 400, 330, 400, 330, 470, 370, 470, iw);

    //machine(ctx, 750, 390, 150,100,  c3,  "indexer");
    machine_group2(ctx, 750, 390, 150,100,  mcolour,
            [{title: "indexer - ingest4", name: "ingest4"}, {title: "indexer - ingest5", name: "ingest5"}]);
    machine_group(ctx, 1000, 390, 150,100,  mcolour,  "jasmin-es", 8);
    disk(ctx, c3, 1010, 450, 30, 50, "FBI");
    up(ctx, 1020, 460, "FBI");
    disk(ctx, c3, 1070, 450, 30, 50, "Haystack");
    up(ctx, 1080, 460, "Haystack");
    arrow(ctx, 'black', 900, 450, 1000, 450, iw);
    arrow_cink(ctx, 'black', 1000, 470, 950, 470, 950, 470, 950, 600, iw);


    machine(ctx, 1040, 520, 150,100,  mcolour,  "db1");
    disk(ctx, c2, 1050, 570, 30, 40, "Moles");
    arrow(ctx, 'black', 1080, 480, 1080, 650, iw);
    arrow(ctx, 'black', 1070, 600, 1070, 650, iw);

    disk(ctx, c4, 540, 490, 80, 140, "/archive");
    add_link(ctx, 550,480, 100, 10, "http://cedaarchiveapp.ceda.ac.uk/cedaarchiveapp/home/");


    web_machine(ctx, 1040, 650, 150,100,  mcolour, "catalogue", "catalogue", "cat.png", "catalogue.ceda.ac.uk" ,"https://catalogue.ceda.ac.uk");

    web_machine(ctx, 860, 720, 150,100,  mcolour, "archive", "archive", "archive.png", "archive.ceda.ac.uk", "http://archive.ceda.ac.uk");

    web_machine(ctx, 860, 600, 150,100,  mcolour, "data", "data_201911251517.ceda-web-S.jasmin.ac.uk", "data.png", "data.ceda.ac.uk", "http://data.ceda.ac.uk");

    web_machine(ctx, 680, 620, 150,100,  mcolour, "dap", "dap", "dap.png", "http://dap.ceda.ac.uk", "http://dap.ceda.ac.uk");

    machine(ctx, 500, 620, 150,100,  mcolour, "ftp2", "ftp2-mgmt.ceda.ac.uk");
    up(ctx, 510, 640, "ftp.ceda.ac.uk");
    machine(ctx, 320, 620, 150,100,  mcolour, "jasmin");

    user(ctx, c10, 650, 750, "archive users", "https://secure.helpscout.net/mailbox/8c6107481a61d1f4/");
    image_link(ctx, "helpscout.png", 660, 755, 20, 20, "https://secure.helpscout.net/mailbox/7b0c55db545d4969/1952553/");
    arrow(ctx, 'black', 680, 750, 880, 770, 1, 5);
    arrow(ctx, 'black', 950, 770, 1050, 730, 1, 5);
    arrow(ctx, 'black', 1050, 710, 950, 680, 1, 5);
    arrow(ctx, 'black', 880, 680, 760, 700, 1, 5);
    arrow(ctx, 'black', 680, 750, 880, 770, 1, 5);

    user(ctx, c10, 400, 750, "jasmin user", "https://secure.helpscout.net/mailbox/8c6107481a61d1f4/");
    image_link(ctx, "helpscout.png", 410, 755, 20, 20, "https://secure.helpscout.net/mailbox/7b0c55db545d4969/1952553/");

    //deposit_nums(ctx, 20, 100, "filerate_2min", "files/s", 1);
    //deposit_nums(ctx, 20, 60, "volrate_2min", "MB/s", 1e-6);

    grab("https://archdash1.ceda.ac.uk/current/api", "current_deposits", 5000);
    //grab("http://archdash1.ceda.ac.uk/downloads/json/methods?start=2019%2F10%2F26&end=2020%2F01%2F24&user=&dataset=&method=&anon=all", "b", 5000);
    ingest_sum(20000);
    uptimerobot(60000);

    show_nums(ctx, 580, 400, "current_deposits", "filerate_2min", "files/s", 1, 2, 10, 30);
    show_nums(ctx, 580, 420, "current_deposits", "volrate_2min", "MB/s", 1e-6, 1, 10000000, 1000000000);
    show_nums(ctx, 390, 420, "current_deposits", "fastq_len", "files", 1, 0, 1000, 100000);
    show_nums(ctx, 390, 470, "current_deposits", "slowq_len", "files", 1, 0, 200000, 1000000);

    show_nums(ctx, 240, 380, "ingest", "ok", "ok", 1, 0);
    show_nums(ctx, 240, 395, "ingest", "fail", "fails", 1, 0, 5, 20);
    show_nums(ctx, 240, 410, "ingest", "running", "running", 1, 0, 10, 30);
    show_nums(ctx, 240, 425, "ingest", "killed", "killed", 1, 0, 2, 10);
    show_nums(ctx, 240, 440, "ingest", "died", "died", 1, 0, 1, 3);




    link_listen(canvas);
</script>




</body>


</html>
