digraph G {

#  rankdir=LR
  rank="source"
  data_provider [shape=egg,style=filled,fillcolor=yellow];
 
  gws  [style=filled,shape=cylinder,fillcolor=gray];
  ds [shape=egg,style=filled,fillcolor=yellow];
  
    subgraph cluster_arrivals {
    label = "Arrivals";
    style=filled;
    color="#ccccff";    
    node [style=filled,fillcolor="blue"];
  arrivals [fillcolor=white,shape=rectangle,href="https://arrivals.ceda.ac.uk" image="images/arrivals_s.png",fontsize=12];
  fileops;
  arrivals_disk  [style=filled,shape=cylinder,fillcolor=gray,href="http://stats.ceda.ac.uk/ingest_state/stream.html?streamname=simple_checks"];
    node [style=striped,shape=rectangle,fillcolor="red;0.2:red;0.2:red;0.2:red;0.2:red"];
  arrivals -> arrivals_disk [penwidth=4];
  fileops -> arrivals_disk;
  }
  
    subgraph cluster_es {
    label = "elastic search";
    style=filled;
    color="#ccffcc";    
    node [style=filled,fillcolor="blue"];
    haystack;
    fbi;
    ingest_logs;
  }

  ingest_control -> ingest_logs;
  ingest_logs -> ingest_mon;

  subgraph cluster_ingest {
    label = "Ingest";
    style=filled;
    color=lightgrey;    
    
   processing_disk  [style=filled,shape=cylinder,fillcolor=gray,href="http://stats.ceda.ac.uk/ingest_state/stream.html?streamname=simple_checks"];
  ingest_control [style=filled,fillcolor="blue"];
  ingest_mon [fillcolor=white,shape=rectangle,
     href="http://stats.ceda.ac.uk/ingest_state/index.html?reclen=30&ingest1=on&ingest2=on&ingest3=on&ingest4=on&ingest5=on&running=on&warn=on&fail=on&killed=on&died=on",
     image="images/ingest_mon_s.png",fontsize=12];
  }

  ingest_control -> fileops;


  subgraph cluster_rabbitmq {
      label = "RabbitMQ";
    style=filled;
    color="#ffccff";
    rbq [style=filled,fillcolor="blue"];
       deposit_rpc [style=striped,shape=rectangle,fillcolor="red;0.2:red;0.2:red;0.2:red;0.2:red"];
         deposit_log [style=striped,shape=rectangle,fillcolor="red;0.2:red;0.2:red;0.2:red;0.2:red"];
    node [style=striped,shape=rectangle,fillcolor="red;0.2:red;0.2:red;0.2:red;0.2:red"];
    fast_indexer_q;
    slow_indexer_q;
    fast_indexer_q -> fbi;
    slow_indexer_q -> fbi;

  }

  subgraph cluster_deposit {
      label = "Deposit server";
    style=filled;
    color=pink;  

  deposit [style=filled,fillcolor="blue"];
  archive   [style=filled,shape=cylinder,fillcolor=gray];
    deposit_web [fillcolor=white,shape=rectangle,href="https://archdash1.ceda.ac.uk/current/a_sum",image="images/deposit_mon_s.png",
                 fontsize=12];
    deposit_log -> deposit_web
  }
  

      deposit_log -> fast_indexer_q;
    deposit_log -> slow_indexer_q;
  

  processing_disk -> deposit [penwidth=4];
  gws -> deposit [penwidth=4];
  arrivals_disk -> deposit [penwidth=4];
  ds -> ingest_control;
  data_provider -> arrivals [penwidth=4];
  data_provider -> processing_disk [penwidth=4, label=pull];
  data_provider -> gws [penwidth=4];
  
  ingest_control -> deposit_rpc;
  

  
  deposit -> archive [penwidth=4];
  
    subgraph cluster_access {
    label = "access";
    style=filled;
    color="#ffffcc";    
    node [style=filled,fillcolor="blue"];
    jasmin;
    ftp2;
    node [fillcolor=white,shape=rectangle,fontsize=12];
    dap [href="https://dap.ceda.ac.uk" image="images/dap_s.png",label="dap.ceda.ac.uk"];
    data [href="http://data.ceda.ac.uk" image="images/data_s.png",label="data.ceda.ac.uk"];
    catalogue [href="https://catalogue.ceda.ac.uk" image="images/cat_s.png",label="catalogue.ceda.ac.uk"];
    archive_site [href="https://archive.ceda.ac.uk" image="images/archive_s.png",label="archive.ceda.ac.uk"];
    archive_site -> catalogue;
    catalogue -> data;
    data -> dap;
  }


  user [shape=egg,style=filled,fillcolor=yellow];

  haystack -> catalogue;
  fbi -> data;

  archive -> jasmin  [penwidth=4];
  archive -> ftp2  [penwidth=4];
  archive -> dap  [penwidth=4];
  
  jasmin -> user [penwidth=4];
  ftp2 -> user [penwidth=4];
  dap -> user [penwidth=4];
  
  deposit -> deposit_log
  
  deposit_rpc -> deposit;
  
}

